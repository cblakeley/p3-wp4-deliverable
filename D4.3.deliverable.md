# Data usage statistics and feedback tools
### Deliverable D4.3

![Fusepool P3 logo](https://avatars0.githubusercontent.com/u/5859504?v=3&s=200)

[TOC]


----------

#### Document History 

| Ver. | Name | Date | Remark |
| :---: | :--- | :---: | :--- |
| v0.0 | Danilo Giacomi| 08.06.2015 | Initial draft |

#### Document Information 

- Deliverable Nr Title: D4.3  Data usage statistics and feedback tools
- Lead: Danilo Giacomi (NET7)
- Authors: Danilo Giacomi (NET7)
- Publication Level: Public

#### Document Context Information 

 - Project (Title/Number): Fusepool P3 (609696)
 - Work Package / Task: WP4 / T4.3
 - Responsible person and project partner: Danilo Giacomi (NET7)

#### Quality Assurance / Review 

- 1st reviewer: Gabor Remenyi (Geox)
- 2nd reviewer: Carl Blakeley (OGL)

#### Official Citations 

Fusepool-P3-D4.2

#### Copyright 

This document contains material, which is the copyright of certain Fusepool P3 consortium parties. This work is licensed under the Creative Commons Attribution 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/.

#### Acronyms and Abbreviations 

| Acronym | Description |
| --- | :--- |
| DoW | Description of Work |

#### Links in this deliverable 

| Title | URL|
| --- | :--- |
| FP3 Community website| http://getfp3.com |
| SOD 2015 | http://www.spaghettiopendata.org/page/benvenut-sod15 |
| ELK | https://www.elastic.co/products |
| platform reference implementation| https://github.com/fusepoolP3/p3-platform-reference-implementation |
| logstash forwarder | https://github.com/elastic/logstash-forwarder|
| kibana on the sandbox |  sandbox.fusepool.info:8387 |

## Executive Summary 


This document details the work performed and planned as part of Deliverable D4.3 / Task 4.3 "Data usage statistics and feedback".

**Status, June 2015:** At the current time this is an **interim report** detailing our goals and approach to ...
{TO DO: - Finish executive summary}

## Introduction 

The Description of Work for the Fusepool P3 project describes the main task of this deliverable as: 

*"T4.3 – Data usage statistics and feedback: tools to assess the usage value of open data and services based
on the automatic analysis of logging and auditing data [...] as well as user interfaces for directly posting feedbacks and requests ..."

The T4.3 task is then composed of two sub-tasks: gathering feedbacks from the users and analyse the services logs.

### Feedbacks 

To let the end users give us feedbacks on the platform and the project, a feedback facility was added to the FP3 Community website (http://getfp3.com). The Jira issue regarding this task is found at https://fusepool.atlassian.net/browse/FPUSER-63 and was resolved around the end of March 2015.

It was wise to have a feedback facility in place at that time, as we have taken part to some public events where we've disseminated about the project - in particular the Spaghetti Open Data SOD2015 (http://www.spaghettiopendata.org/page/benvenut-sod15) where we've also ran a hackathon session to involve the community and to better share the knowledge about the Fusepool P3 platform.

During the SOD 2015 Hackathon we've also ran a challenge for creating applications using the data processed with the Fusepool P3 platform which has seen the partecipation of some groups of people and which ended up with the release of two applications. More information on this can be found on the Deliverable D4.2.

Feedbacks about the platform are also being requested to the stackeholders identified by the Work Package 6 in the form of a questionnaire sent to them, with instruction on how to perform the needed steps to set up the platform as well as on using it.

### Data usage statistics 

To analyse the usage of our platform, and to offer a flexible and visual platform for that, we've used the Elasticsearch-Logstash-Kibana stack (ELK - https://www.elastic.co/products).
The ELK stack is based on three core components, each of which offers its services to the stack:

#### Elasticsearch 

Elasticsearch is a search engine based on the Apache Lucene software, which provides a more useable and concise API, scalability, and operational tools on top of Lucene’s search implementation itself.
Apache Lucene is a robust, extremely popular and proven piece of software. Also Apache SOLR - another largely used and well-known search engine - uses it.
In the ELK stack Elasticsearch is used to store the logs and to quick retrieve them at visualization time

#### Logstash 

Logstash is a data pipeline that helps process logs and other event data from a variety of systems, in the ELK stack it is used to process the data and send them to the Elasticsearch search engine. 
Logstash has several plugins to process various type of logs and to interact with different other softwares to which it can send the processed logs. In the ELK stack Logstash is used to send processed logs to Elasticsearch where they are indexed and, later on, retrieved

#### Kibana 

Kibana is the third and last element of the ELK stack and works with Elasticsearch from which it retrieves the data. Kibana is the analytics and visualization tool of the ELK stack that lets you search, view, and interact with data stored in Elasticsearch indices.

#### Logstash forwarder and Httpry 

Another piece of software is needed to make the whole logging system work, which takes the logs and hands them to the ELK stack. Such software is logstash forwarder (https://github.com/elastic/logstash-forwarder), a linux daemon programmed to scan for changes on selected logs files and configured to send all new lines to the Logstash in the ELK stack.
Logstash forwarder has been configured to work with another commonly available logging system, Httpry (https://github.com/jbittel/httpry), which is able to collect and log all the accesses to the server it's run on. Httpry can be ran specifying the ports of the request to log, the fields to log, and the file into witch the logs will be saved.

In the platform reference implementation docker image (https://github.com/fusepoolP3/p3-platform-reference-implementation) Httpry has been configured to run as a daemon, listening on the ports of all the services available in the platform itself. It logs the requested URL (relative to the host), and other parameters of each request received.

#### Fusepool P3 platform reference implementation docker image 

In the Fusepool P3 platform reference implementation docker image (https://github.com/fusepoolP3/p3-platform-reference-implementation) the ELK stack is distributed as a docker compose multi-container application, setting up and running the three core components, Elasticsearch, logstash and kibana. It has been configured with a ssl certificate/key couple created using "localhost" as the hostname, specifically with the following command:

`openssl req -x509 -batch -nodes -newkey rsa:2048 -keyout logstash-forwarder.key -out logstash-forwarder.crt -days 3650 -subj /CN=localhost`

This created a ssl certificate/key couple valid ten years and to be used on a machine called "localhost"

Then, in the platform reference implementation, the Httpry is ran at startup time along with logstash forwarder which has been configured to watch the Httpry log file and send everything written there to the Logstash, in the ELK stack. The startup command for Httpry, as found in the platform reference implementation is the following:

`httpry -f source-ip,request-uri -d -i eth0 'tcp port 8080 or 8181 or 8151 or 8200 or 8201 or 8202 or 8203 or 8204 or 8205 or 8300 or 8301 or 8302 or 8303 or 8304 or 8305 or 8306 or 8307 or 8308 or 8310 or 8386' -o /var/log/httpry.log`

which tells the Httpry service to watch the eth0 interface for accesses on the port listed, logging the request URI and the IP of the user. With those information we can understand which services are accessed and recognise the geographic zone generating each request.


#### Logs analysis example

The logs gathered with the tools just described are visualized using the Kibana tool, which offer several ways to observe the data. 
The Fusepool sandbox contains all the tools and can be used as an example of what can be achieved with the tools. A starting point can be the Dashboard - http://sandbox.fusepool.info:8387/#/dashboard/Dashboard?_g=(refreshInterval:(display:Off,pause:!f,section:0,value:0),time:(from:now%2Fw,mode:quick,to:now%2Fw))&_a=(filters:!(),panels:!((col:6,id:access-modes,row:1,size_x:4,size_y:3,type:visualization),(col:10,id:total-access-count,row:1,size_x:3,size_y:2,type:visualization),(col:1,id:Hourly-access,row:1,size_x:5,size_y:3,type:visualization)),query:(query_string:(analyze_wildcard:!t,query:'*')),title:Dashboard) - which has been configured to show three widgets, as shown in the following images

![Dashboard](https://github.com/fusepoolP3/p3-wp4-deliverable/blob/master/dashboard.png?raw=true)

The image shows a view on the logs collected in the last week, the time frame can be adjusted by clicking on the top-right corner, on the "This week" writing. It opens up a panel with several possibility, clicking on them the widgets will be updated with the logs from the selected time frame. The following image shows them.

![Time Frames](https://github.com/fusepoolP3/p3-wp4-deliverable/blob/master/time-frame.png?raw=true)

The first widget, on the left, shows the access in the selected time frame, grouped by hour. This, as we'll see, can be adjusted to the needs in the creation of the widget, in the "Visualize" panel.

The second widget, the pie chart, shows the top ten access modes taken from the logged request. The legend shows the service requested, moving the mouse over them, the related slice of the chart is highlighted. The same happens when the mouse is over a slice, the related legend entry is highlighted.

The last widget, on the right, shows to total access count as a number.

These three widgets are just example of what can be done with the tool, but represent interesting facts about the platform and its usage.

By clicking on the "Visualize" tab, in the top menu, it is possible to create new widgets or to view and modify an existing one. In this visualization the widget is larger and can be studied in details.

The following image shows all the available type of visualization, and thus dashboard widgets, the user can choose from

![Visualize choices](https://github.com/fusepoolP3/p3-wp4-deliverable/blob/master/visualize-choices.png?raw=true)





